<!DOCTYPE html>
<!--QUIZ W/ VH -->
<!--Interactive w/ VH-->
<!--SOUND-->
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Work Sheet with Virtual Human and WebGazer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
   
    
    <style>

    
   /* SPLIT SCREEN */ 
   body {
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
    }

    .panel {
          
          height: 100%;
          overflow-y: scroll; 
          border: 1px solid #ccc;
          position: relative; 
        }

        .panel-left {
          background-color: #f0f0f0;
          z-index: 5; 
          width: 55%;
        }

        .panel-right {
          background-color: #d0e0f0;
          position: relative;
          z-index: 10; 
          width: 45%;
        }


    button {
        display: block;
        margin-top: 20px;
        padding: 10px 15px;
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
        margin-bottom: 20px;
    }

    button:hover {
        background-color: #45a049;
    }

    .button-container {
        display: flex; 
        justify-content: flex-start; 
        gap: 10px; 
    }

    .text-box {
        border: 2px solid #333; 
        padding: 20px; 
        width: 90%; 
        height: 500px;
        background-color: #f0f0f0; 
        font-family: Arial, sans-serif;
        resize: none; 
        overflow-y: scroll; 
        margin-bottom: 20px;
    }

    .question {
        margin-bottom: 20px;
    }

    .question h3 {
        margin-bottom: 10px;
    }

    

    .char-count {
        margin-top: 10px;
        font-size: 14px;
        color: #555;
    }

   

     /* UNITY CONTAINER */
     #unity-container.unity-desktop {
          width: 100%; 
          height: 100%; 
          position: relative; 
          z-index: 4; 
        }
  
        #unity-canvas {
          width: 100%;
          height: 100%;
          background: #231F20;
          z-index: 4;
        }
  
        #unity-loading-bar {
          position: absolute; 
          left: 50%; 
          top: 50%; 
          transform: translate(-50%, -50%);
          display: none;
          z-index: 4;
        }
  
        #unity-logo { width: 154px; height: 130px; }
        #unity-progress-bar-empty { width: 141px; height: 18px; }
        #unity-progress-bar-full { width: 0%; height: 18px; }
        #unity-footer { position: relative; z-index: 4; }

    </style>
  </head>


  <body>
    <<script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert@2.1.2/dist/sweetalert.min.js"></script>
    <div class="panel panel-left">
        <div id="unity-container" class="unity-desktop">
          <canvas id="unity-canvas"></canvas>
          <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
              <div id="unity-progress-bar-full"></div>
            </div>
          </div>
          <div id="unity-footer"></div>
        </div>
      </div>
    
  

     <!-- RIGHT SIDE: Worksheet -->
     <div class="panel panel-right">
    
       <!--The Story-->
       <div class="text-box">

        <h4>The Sun God and the Hungry Moon </h4>
        
        <p> Long ago, in a small village nestled between two towering mountains, the people lived peacefully, basking in the warm glow of the sun. They were happy, their fields were lush, and their harvests plentiful. But as the days grew shorter and winter approached, a strange darkness began to creep over their once-bright village.

          Every night, the moon seemed to grow larger in the sky, its pale light turning a sickly shade of green. Whispers spread through the village like wildfire: the moon was hungry. It was said that if the moon's green light touched you, you would vanish without a trace, swallowed whole by the moon itself.
          
          The villagers became terrified. They shuttered their windows and locked their doors at night. Parents kept their children close, and no one dared venture out after dark. But even hiding indoors was not always safe. Every morning, someone was found missing, their homes empty, with only a faint green glow lingering in the air.
          
          In desperation, the villagers gathered at the town square to consult the village elder, a wise old woman named Maia. “The moon has been cursed,” Maia told them, her voice trembling with age and fear. “It has become a ravenous creature that devours the innocent. Only the Sun God, Solarius, can save us.”
          
          “But how do we call upon Solarius?” the villagers asked, their voices filled with panic.
          
          “The Sun God only listens to those who prove their devotion,” Maia explained. “One of you must journey to the Sacred Peak at sunrise and light the ancient Sun Flame to summon him.”
          
          The villagers exchanged nervous glances. The journey to the Sacred Peak was perilous, especially with the moon’s monstrous green light lurking in the sky. But before anyone could volunteer, a young boy named Leo stepped forward.
          
          “I will go,” Leo said, his voice steady despite the fear that gnawed at him. He was only twelve, but he was brave, and he could not bear to see his village suffer any longer.
          
          His parents protested, but Leo was determined. With nothing more than a satchel filled with dried fruit, a flask of water, and a flint for starting fires, he set off at the first light of dawn.
          
          The journey to the Sacred Peak was treacherous. As Leo climbed higher, the sun began to set, and the moon crept up into the sky. It was enormous, its green glow casting an eerie light on the mountain path. The air grew cold, and Leo’s breath puffed in front of him like tiny clouds.
          
          As he trudged on, the moon’s sinister voice echoed through the air. “Turn back, little boy,” it whispered, the sound sending chills down his spine. “You cannot escape me. I will feast on you as I have feasted on your friends.”
          
          Leo’s heart pounded, but he kept moving. He couldn’t let the moon’s threats stop him. He thought of the people in his village, the friends and neighbors who had disappeared, and it filled him with determination.
          
          Finally, after hours of climbing, Leo reached the Sacred Peak. At the summit stood an ancient stone altar covered in sun symbols. In the center was a metal bowl filled with old ashes—the remnants of past fires lit by those who had called upon Solarius.
          
          Leo’s fingers shook as he pulled out his flint. The moon’s green light was growing brighter, and he could hear it chuckling. “You’re too late, little one,” the moon hissed. “Your village will be mine before the night is through.”
          
          Desperately, Leo struck the flint again and again. But each time, the spark fizzled out. “Come on,” he muttered, tears stinging his eyes. He couldn’t fail—not now, not when the village needed him most.
          
          Then, just as despair threatened to overwhelm him, a small spark caught in the dry ashes. A tiny flame flickered to life, and with it, the sun symbols on the altar began to glow. The flame grew brighter, warmer, until it was a blazing fire that roared toward the sky.
          
          Suddenly, the sky began to change. The darkness that had consumed the world was pushed back as a brilliant golden light spread across the horizon. The villagers back in the valley watched in awe as the sun seemed to rise again, even though it was still night.
          
          A powerful, radiant figure emerged from the blazing fire: Solarius, the Sun God. His golden armor shimmered, and his eyes burned like twin suns. “Who has called upon me?” he thundered, his voice shaking the mountains.
          
          “It was I,” Leo said, bowing low. “The moon has turned into a monster, devouring our people. Please, we need your help!”
          
          Solarius looked up at the moon, which now hung in the sky like a bloated, green balloon. The moon let out a shriek, its once-taunting voice now filled with fear.
          
          “You have grown greedy, old friend,” Solarius said, raising his shining spear. “You were meant to guide the night, not consume the innocent!”
          
          With a swift motion, Solarius hurled his spear toward the moon. It soared through the air, trailing a fiery light behind it. The moon tried to dodge, but it was too slow. The spear struck it with a blinding flash, and the moon let out a terrible scream.
          
          The green light faded, and the moon began to shrink, its monstrous form dissolving into soft, silvery light. The night sky returned to its peaceful state, and the stars twinkled once more.
          
          Solarius turned to Leo, a proud smile on his face. “You have done well, young one. Your courage has saved your village.”
          
          “But the moon... will it return?” Leo asked, still trembling.
          
          Solarius nodded. “The moon was corrupted by its own greed, but I have restored its true nature. It will no longer harm your people. However,” he added with a twinkle in his eye, “I will keep a close watch.”
          
          The sun god raised his hand, and with a burst of golden light, he vanished. The fire on the altar dimmed, leaving Leo alone on the mountaintop.
          
          When Leo returned to the village, he was greeted with cheers and laughter. The people celebrated him as a hero, but Leo only smiled shyly, knowing it was Solarius who had truly saved them.
          
          The moon returned to its normal, peaceful glow, watching over the village without hunger or malice. And from that night onward, the villagers would tell the tale of the brave boy who journeyed to the Sacred Peak and called upon the Sun God to save them from the Hungry Moon.
          
          And every year, on the longest night of winter, they lit a fire on the mountain to honor Solarius and remember the boy who had saved them all.
          
        </p>
        </div>
        
      <form id="quiz-form">
        <div class="question" id="question1">
          <h3>What underlying reason drove the moon’s transformation into a monstrous entity beyond mere hunger?</h3>
          <label><input type="radio" name="q1" value="incorrect"> Its desire for admiration from the villagers </label><br>
          <label><input type="radio" name="q1" value="incorrect"> A curse from a neighboring village </label><br>
          <label><input type="radio" name="q1" value="correct"> Its envy of the Sun God’s eternal light  </label><br>
          <label><input type="radio" name="q1" value="incorrect"> Its stress of protecting the village </label><br>
        </div>

        <div class="question" id="question2">
          <h3>Why was it crucial for Leo to light the Sun Flame precisely at sunrise?</h3>
          <label><input type="radio" name="q2" value="incorrect"> The Sun God would only be able to answer during daylight hours </label><br>
          <label><input type="radio" name="q2" value="incorrect">It symbolized the unity between the moon and the sun </label><br>
          <label><input type="radio" name="q2" value="incorrect"> It was part of a tradition that bound the villagers to the gods          </label><br>
          <label><input type="radio" name="q2" value="correct"> The Sun Flame’s power was strongest during the transition from night to da </label><br>
        </div>

        <div class="question" id="question3">
          <h3>What specific challenge did Leo face as he neared the Sacred Peak that tested more than his physical endurance?</h3>
          <label><input type="radio" name="q3" value="incorrect"> A chasm guarded by mythical creatures </label><br>
          <label><input type="radio" name="q3" value="incorrect">A blizzard that froze the path </label><br>
          <label><input type="radio" name="q3" value="correct"> Illusions created by the moon reflecting his deepest fears </label><br>
          <label><input type="radio" name="q3" value="incorrect"> An encounter with a guardian spirit demanding a sacrifice </label><br>
        </div>

        <div class="question" id="question4">
          <h3>How did Maia’s knowledge of the moon’s curse connect to her past experiences?</h3>
          <label><input type="radio" name="q4" value="correct"> She had witnessed a similar curse when she was a child </label><br>
          <label><input type="radio" name="q4" value="incorrect"> She had once attempted to summon Solarius but failed </label><br>
          <label><input type="radio" name="q4" value="incorrect"> She had been the moon’s guardian before becoming the village elder </label><br>
          <label><input type="radio" name="q4" value="incorrect"> She had caused the moon’s corruption through a forgotten ritual</label><br>
        </div>
        
        <div class="question" id="question5">
          <h3>When Solarius confronted the moon, why did he hesitate before striking it with his spear?</h3>
          <label><input type="radio" name="q5" value="incorrect"> He was waiting for a sign from Leo </label><br>
          <label><input type="radio" name="q5" value="correct"> The moon was once his closest celestial companion </label><br>
          <label><input type="radio" name="q5" value="incorrect"> He feared harming the villagers trapped inside </label><br>
          <label><input type="radio" name="q5" value="incorrect"> He sensed a greater threat beyond the moon’s corruption          </label><br>
        </div>

        <div class="question" id="question6">
          <h3>What realization did Leo come to when the moon offered to stop its attacks if he abandoned his mission?</h3>
          <label><input type="radio" name="q6" value="correct"> The moon feared Leo’s connection to Solarius</label><br>
          <label><input type="radio" name="q6" value="incorrect"> The moon was genuinely remorseful </label><br>
          <label><input type="radio" name="q6" value="incorrect"> The villagers were unknowingly complicit in the moon’s curse </label><br>
          <label><input type="radio" name="q6" value="incorrect">The curse could only be broken by sacrificing himself </label><br>
        </div>

        <div class="question" id="question7">
          <h3>What internal struggle did Leo face as he climbed toward the Sacred Peak to summon Solarius?</h3>
          <label><input type="radio" name="q7" value="incorrect"> He was unsure if Solarius would even respond to his call for help </label><br>
          <label><input type="radio" name="q7" value="incorrect"> He feared that the villagers would not appreciate his sacrifice </label><br>
          <label><input type="radio" name="q7" value="correct"> He doubted whether his courage alone would be enough to save his village</label><br>
          <label><input type="radio" name="q7" value="incorrect"> He struggled with the fear of heights that threatened to paralyze him </label><br>
        </div>

        <div class="question" id="question8">
          <h3>After the moon was restored to its peaceful state, what lesson did the villagers learn about their relationship with celestial forces?</h3>
          <label><input type="radio" name="q8" value="correct"> Balance and respect for the natural order were essential  </label><br>
          <label><input type="radio" name="q8" value="incorrect">The gods could not be trusted to protect them </label><br>
          <label><input type="radio" name="q8" value="incorrect"> They needed to seek power to protect themselves </label><br>
          <label><input type="radio" name="q8" value="incorrect"> Sacrifices to celestial beings were necessary to ensure peace </label><br>
        </div>

        <!-- Submit and Exit Buttons -->
        <div class="button-container">
          <button type="submit">Submit</button>
        </div>
      </form>
    </div>
 

 
<!-- JavaScript -->
<script>
  //turn off the camera
  webgazer.showVideoPreview(false) ;
</script>

<script>
  //turn off the camera
  webgazer.showVideoPreview(false) ;
</script>

  <!-- Validate quiz -->
  <script src="js/quiz_validationDE.js"></script>

   <!-- UNITY SCRIPTS -->
   <script>
    var container = document.querySelector("#unity-container");
    var canvas = document.querySelector("#unity-canvas");
    var loadingBar = document.querySelector("#unity-loading-bar");
    var progressBarFull = document.querySelector("#unity-progress-bar-full");
    var warningBanner = document.querySelector("#unity-warning");


    var buildUrl = "BuildLUCKY";
      var loaderUrl = buildUrl + "/LUCKY.loader.js";
      var config = {
        dataUrl: buildUrl + "/LUCKY.data",
        frameworkUrl: buildUrl + "/LUCKY.framework.js",
        codeUrl: buildUrl + "/LUCKY.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "Attempt1",
        productVersion: "0.1",
      };

      var script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          progressBarFull.style.width = 100 * progress + "%";
              }).then((unityInstance) => {
                loadingBar.style.display = "none";
                window.UnityInstance = unityInstance;
              }).catch((message) => {
                alert(message);
              });
            };
      
      document.body.appendChild(script);
      

</script>

<script>

  function triggerUnityAnimation() {
    if (typeof UnityInstance !== 'undefined' && UnityInstance !== null) {
        UnityInstance.SendMessage('WaveObject', 'TriggerAnimation');
    } else {
        console.error("UnityInstance is not defined or null.");
    }
}

function triggerUnityTTS(message) {
    if (typeof UnityInstance !== 'undefined' && UnityInstance !== null) {
        UnityInstance.SendMessage('WaveObject', 'TriggerSpeech', message);
    } else {
        console.error("UnityInstance is not defined or null.");
    }
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

var count = 0;
var alerted = false;
var vhresponse = ["I'm here for you if you need me"," Are you having trouble focusing?","Would you like my assistance?","Type 1 if you would like a stretch break", "Would you like to talk?","Let me know if you need help to refocus", "Are you fine?","How about a break to chat?"," Just say the word and I'm there","My job is to help you, feel free to reach out."];


// Array to hold gaze prediction points
let gazePoints = [];
webgazer.setGazeListener(function(data, elapsedTime) {
  if (data == null) {
      return;
  }

  var xprediction = data.x; // X coordinate
  var yprediction = data.y; // Y coordinate
  // Store the prediction point
  gazePoints.push({
  x: xprediction,
  y: yprediction,
  time: elapsedTime
  });
  
  var viewportWidth = window.innerWidth;
  var viewportHeight = window.innerHeight;

  var minX = viewportWidth * 0.1; 
  var maxX = viewportWidth * 0.9; 
  var minY = viewportHeight * 0.1; 
  var maxY = viewportHeight * 0.9; 

  // Check if gaze is off-screen
  if(alerted){

    async function changeAlert() {
      await sleep(15000);
      alerted = false;
    }

    changeAlert();

  } else {
    if (xprediction < minX || xprediction > maxX || yprediction < minY || yprediction > maxY) {
      count++;
      if(count > 30){
        try {
          // Send notification to server that user looked off screen
          fetch('/off-screen-counter', {
            method: 'POST',
          });
        } catch (error) {
          console.error('Error:', error);
        }
        
        triggerUnityAnimation();
        triggerUnityTTS(vhresponse[Math.floor(Math.random() * vhresponse.length)]);
        alerted = true;
        count = 0;
      }
      } else {
        count = 0;
      }
  }
  
   // Optionally, log the data for debugging
   console.log(`Gaze Point: (${xprediction}, ${yprediction}), Time: ${elapsedTime}`);
}).begin();
webgazer.showPredictionPoints(false);
</script>
    
  </body>
</html>
